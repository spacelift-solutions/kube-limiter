# Kube Limiter

A Kubernetes resource analysis CLI tool that generates resource type allowlists for Spacelift stacks.

## Overview

Kube Limiter analyzes Kubernetes manifests defined in a `kustomization.yaml` file and generates two allowlist files for use with Spacelift:
- Allowed resource types for deployment
- Prune whitelist for cleanup operations

## But Why?

Spacelift stacks will by default look at all CRDs and APIS within a cluster and generate a really long command to manage resources.
That command is built off two files on the disk, the `/mnt/workspace/.spacelift-kubernetes-allowed-resource-types` and `/mnt/workspace/.spacelift-kubernetes-prune-whitelist-resource-types` files.
If your cluster has a lot of CRDs and APIS, this can lead to very long commands that can potentially take minutes to run.
This tool helps to limit the scope of those commands by analyzing the actual resources defined in your `kustomization.yaml` and generating concise allowlists.
It has seen speed improvements up to 45x in some cases, making deployments and pruning operations much faster.

The only downside of using this tool is this does *not* support destroying resources.
So if you delete a resource from your `kustomization.yaml`, it will not be removed from the cluster.
If you want to destroy resources, you will need to add the `kube:destroy` label to your Spacelift stack, which will skip this tool and allow the default Spacelift behavior to take over.
(but this will also increase the command length and execution time for those runs)

## How It Works

1. Reads `kustomization.yaml` from the current directory (this is generated by spacelift, if you dont have one)
2. Analyzes each Kubernetes manifest file referenced in the resources list
3. Connects to a Kubernetes cluster to resolve Group/Version/Kind (GVK) information
4. Generates two output files with comma-separated resource types

## Generated Files

- `/mnt/workspace/.spacelift-kubernetes-allowed-resource-types` - Resource types allowed for deployment
- `/mnt/workspace/.spacelift-kubernetes-prune-whitelist-resource-types` - Resource types allowed for pruning

## Prerequisites

- Go 1.24+
- Access to a Kubernetes cluster (kubeconfig)
- `kustomization.yaml` file in the working directory

## Dependencies

- `k8s.io/client-go` - Kubernetes Go client
- `k8s.io/apimachinery` - Kubernetes API machinery
- `gopkg.in/yaml.v3` - YAML parsing

## Usage

```bash
go run .
```

The tool will:
1. Check if execution should continue based on Spacelift stack labels
2. Parse the `kustomization.yaml` file
3. Analyze each resource file to determine its GVK
4. Query the Kubernetes API to get resource information
5. Generate the allowlist files

## Environment Variables

- `TF_VAR_spacelift_stack_labels` - Controls execution; tool skips if contains "kube:destroy"
- `SPACELIFT_DEBUG` - Enables debug logging when set

## Build

```bash
go build -o kube-limiter .
```

## Project Structure

- `main.go` - Main entry point and orchestration logic
- `kubernetes.go` - Kubernetes API client and GVK resolution
- `types.go` - Data structures for kustomization config
- `commaSeparated.go` - Utility for building comma-separated strings
- `logger.go` - Structured logging setup

## Example Output

For a deployment containing a Deployment and Service, the tool might generate:

**Allowed resource types:**
```
deployments.apps,services
```

**Prune whitelist:**
```
apps/v1/Deployment,core/v1/Service
```

## Integration with Spacelift

This tool is designed to run within Spacelift workflows to automatically generate resource allowlists based on the actual Kubernetes resources being deployed, providing security and operational guardrails.